(function(){"use strict";var e={title_page:/^((?:title|credit|author[s]?|source|notes|draft date|date|contact|copyright)\:)/gim,scene_heading:/^((?:\*{0,3}_?)?(?:(?:int|ext|est|i\/e)[. ]).+)|^(?:\.(?!\.+))(.+)/i,scene_number:/( *#(.+)# *)/,transition:/^((?:FADE (?:TO BLACK|OUT)|CUT TO BLACK)\.|.+ TO\:)|^(?:> *)(.+)/,dialogue:/^([@]+[0-9A-Za-z# (,._\-'’)]*|[A-Z]+[0-9A-Z# (,._\-'’)]*)(\^?)?(?:\n(?!\n+))([\s\S]+)/,parenthetical:/^(\(.+\))$/,action:/^(.+)/g,centered:/^(?:> *)(.+)(?: *<)(\n.+)*/g,section:/^(#+)(?: *)(.*)/,synopsis:/^(?:\=(?!\=+) *)(.*)/,note:/^(?:\[{2}(?!\[+))(.+)(?:\]{2}(?!\[+))$/,note_inline:/(?:\[{2}(?!\[+))([\s\S]+?)(?:\]{2}(?!\[+))/g,boneyard:/(^\/\*|^\*\/)$/g,page_break:/^\={3,}$/,line_break:/^ {2}$/,emphasis:/(_|\*{1,3}|_\*{1,3}|\*{1,3}_)(.+)(_|\*{1,3}|_\*{1,3}|\*{1,3}_)/g,bold_italic_underline:/(_{1}\*{3}(?=.+\*{3}_{1})|\*{3}_{1}(?=.+_{1}\*{3}))(.+?)(\*{3}_{1}|_{1}\*{3})/g,bold_underline:/(_{1}\*{2}(?=.+\*{2}_{1})|\*{2}_{1}(?=.+_{1}\*{2}))(.+?)(\*{2}_{1}|_{1}\*{2})/g,italic_underline:/(?:_{1}\*{1}(?=.+\*{1}_{1})|\*{1}_{1}(?=.+_{1}\*{1}))(.+?)(\*{1}_{1}|_{1}\*{1})/g,bold_italic:/(\*{3}(?=.+\*{3}))(.+?)(\*{3})/g,bold:/(\*{2}(?=.+\*{2}))(.+?)(\*{2})/g,italic:/(\*{1}(?=.+\*{1}))(.+?)(\*{1})/g,lyric:/^(\~.+)/g,underline:/(_{1}(?=.+_{1}))(.+?)(_{1})/g,splitter:/\n{2,}/g,cleaner:/^\n+|\n+$/,standardizer:/\r\n|\r/g,whitespacer:/^\t+|^ {3,}/gm},t=function(t){return t.replace(e.boneyard,"\n$1\n").replace(e.standardizer,"\n").replace(e.cleaner,"").replace(e.whitespacer,"")},a=function(a){for(var s,n,r,i,p,l,c,u,d=t(a).split(e.splitter),o=d.length,h=[];o--;)if(s=d[o],e.title_page.test(s))for(n=s.replace(e.title_page,"\n$1").split(e.splitter).reverse(),l=0,c=n.length;c>l;l++)r=n[l].replace(e.cleaner,"").split(/\:\n*/),h.push({type:r[0].trim().toLowerCase().replace(" ","_"),text:r[1].trim()});else if(n=s.match(e.scene_heading))i=n[1]||n[2],i.indexOf("  ")!==i.length-2&&((p=i.match(e.scene_number))&&(p=p[2],i=i.replace(e.scene_number,"")),h.push({type:"scene_heading",text:i,scene_number:p||void 0}));else if(n=s.match(e.centered))h.push({type:"centered",text:n[0].replace(/>|</g,"")});else if(n=s.match(e.transition))h.push({type:"transition",text:n[1]||n[2]});else if((n=s.match(e.dialogue))&&n[1].indexOf("  ")!==n[1].length-2){for(n[2]&&h.push({type:"dual_dialogue_end"}),h.push({type:"dialogue_end"}),r=n[3].split(/(\(.+\))(?:\n+)/).reverse(),l=0,c=r.length;c>l;l++)i=r[l],i.length>0&&h.push({type:e.parenthetical.test(i)?"parenthetical":"dialogue",text:i});h.push({type:"character",text:n[1].replace(/\@/g,"").trim()}),h.push({type:"dialogue_begin",dual:n[2]?"right":u?"left":void 0}),u&&h.push({type:"dual_dialogue_begin"}),u=n[2]?!0:!1}else(n=s.match(e.section))?h.push({type:"section",text:n[2],depth:n[1].length}):(n=s.match(e.lyric))?h.push({type:"lyric",text:n[0].replace(/\~/,"")}):(n=s.match(e.synopsis))?h.push({type:"synopsis",text:n[1]}):(n=s.match(e.note))?h.push({type:"note",text:n[1]}):(n=s.match(e.boneyard))?h.push({type:"/"===n[0][0]?"boneyard_begin":"boneyard_end"}):e.page_break.test(s)?h.push({type:"page_break"}):e.line_break.test(s)?h.push({type:"line_break"}):h.push({type:"action",text:s.replace(/\!/,"")});return h},s={note:"<!-- $1 -->",line_break:"<br />",bold_italic_underline:'<span class="bold italic underline">$2</span>',bold_underline:'<span class="bold underline">$2</span>',italic_underline:'<span class="italic underline">$2</span>',bold_italic:'<span class="bold italic">$2</span>',bold:'<span class="bold">$2</span>',italic:'<span class="italic">$2</span>',underline:'<span class="underline">$2</span>'};s.lexer=function(t){if(t){var a,n,r=["underline","italic","bold","bold_italic","italic_underline","bold_underline","bold_italic_underline"],i=r.length;for(t=t.replace(e.note_inline,s.note).replace(/\\\*/g,"[star]").replace(/\\_/g,"[underline]").replace(/\n/g,s.line_break);i--;)a=r[i],n=e[a],n.test(t)&&(t=t.replace(n,s[a]));return t.replace(/\[star\]/g,"*").replace(/\[underline\]/g,"_").trim()}};var n=function(e,t,n){void 0===n&&"function"==typeof t&&(n=t,t=void 0);for(var r,i,p,l=a(e),c=l.length,u=[],d=[];c--;)switch(r=l[c],r.text=s.lexer(r.text),r.type){case"title":u.push("<h1>"+r.text+"</h1>"),i=r.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"credit":u.push('<p class="credit">'+r.text+"</p>");break;case"author":u.push('<p class="authors">'+r.text+"</p>");break;case"authors":u.push('<p class="authors">'+r.text+"</p>");break;case"source":u.push('<p class="source">'+r.text+"</p>");break;case"notes":u.push('<p class="notes">'+r.text+"</p>");break;case"draft_date":u.push('<p class="draft-date">'+r.text+"</p>");break;case"date":u.push('<p class="date">'+r.text+"</p>");break;case"contact":u.push('<p class="contact">'+r.text+"</p>");break;case"copyright":u.push('<p class="copyright">'+r.text+"</p>");break;case"scene_heading":d.push("<h3"+(r.scene_number?' id="'+r.scene_number+'">':">")+r.text+"</h3>");break;case"transition":d.push("<h2>"+r.text+"</h2>");break;case"dual_dialogue_begin":d.push('<div class="dual-dialogue">');break;case"dialogue_begin":d.push('<div class="dialogue'+(r.dual?" "+r.dual:"")+'">');break;case"character":d.push("<h4>"+r.text+"</h4>");break;case"parenthetical":d.push('<p class="parenthetical">'+r.text+"</p>");break;case"dialogue":d.push("<p>"+r.text+"</p>");break;case"dialogue_end":d.push("</div> ");break;case"dual_dialogue_end":d.push("</div> ");break;case"section":d.push('<p class="section" data-depth="'+r.depth+'">'+r.text+"</p>");break;case"synopsis":d.push('<p class="synopsis">'+r.text+"</p>");break;case"lyric":d.push('<p class="lyric">'+r.text+"</p>");break;case"note":d.push("<!-- "+r.text+"-->");break;case"boneyard_begin":d.push("<!-- ");break;case"boneyard_end":d.push(" -->");break;case"action":d.push("<p>"+r.text+"</p>");break;case"centered":d.push('<p class="centered">'+r.text+"</p>");break;case"page_break":d.push("<hr />");break;case"line_break":d.push("<br />")}return p={title:i,html:{title_page:u.join(""),script:d.join("")},tokens:t?l.reverse():void 0},"function"==typeof n?n(p):p},r=function(e,t){return r.parse(e,t)};r.parse=function(e,t,a){return n(e,t,a)},"undefined"!=typeof module?module.exports=r:this.fountain=r}).call(this);